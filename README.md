# Мини-ETL для вычисления агрегатов по временным окнам и обнаружения аномалий

Мини-ETL для вычисления агрегатов по временным окнам и обнаружения аномалий. Модульная структура позволяет быстро добавлять новые детекторы, менять конфигурацию и интегрировать хранилище (ClickHouse).

## Что реализовано

ETL с генератором синтетики (локальная отладка и масштабный режим).

Набор детекторов: z-score, mad, rolling, и возможность подключать ML-детекторы.

Сохранение отчётов и простая система алертов (StdOut + возможность расширения).

Тесты (pytest) для основных компонентов.

## Быстрый старт (локально)

### Установить зависимости и пакет в editable режиме:

```
python -m pip install -r requirements.txt
python -m pip install -e .
```

### (Опционально) Поднять ClickHouse:

```
docker compose up -d
# проверить: http://localhost:8123
```

### Запустить pipeline:

```
make pipeline
# или
python -m pipeline.runner run --config config/pipeline.yaml
```

### Запустить тесты:

```
pytest -q
```

## Конфиг

Основной файл конфигурации: `config/pipeline.yaml`. В нём настраиваются:

* параметры ClickHouse,
* размер окна и батча,
* список детекторов с параметрами.

### Сниппет:

```
detectors:
  - type: zscore
    threshold: 3.0
  - type: mad
    threshold: 3.5
```

## Как расширять

Добавить детектор: положить класс в `src/infrastructure/detectors/` и зарегистрировать в `build_detectors`.

Добавить sink: реализовать интерфейс `AlertSink` и передать в `AnomalyDetectionService`.

Подключить реальную ClickHouse-витрину: реализовать методы репозитория (`read_latest_window`, `persist_report`).

## Тесты и воспроизводимость

Юнит-тесты покрывают ключевые детекторы и сценарии.

Для reproducibility: есть Makefile с командами поднятия окружения, сидирования данных и запуска пайплайна.

## Почему этот проект полезен

Быстро демонстрирует подход к детекции аномалий с фокусом на инженерные практики: конфигурируемость, тесты, чёткая граница слоёв.

Легко адаптируется под разные источники данных и требования к алертам.

## Короткие команды

```
make install      # установка и pip install -e .
make infra-up     # поднять ClickHouse
make pipeline     # запустить пайплайн
make test         # pytest
make infra-down   # опустить ClickHouse
```